<html><head><title>Cincomancia</title><style>

html { background-color: #d4d0c8; transform-origin: 0 0; transform: scale(0.5) } /* TODO dynamic scale */
html, body, div, img { user-select: none; /* No prefix supported by Chrome and Opera */
                   -ms-user-select: none; /* Internet Explorer/Edge */
                  -moz-user-select: none; /* Firefox */
                -khtml-user-select: none; /* Konqueror HTML */
               -webkit-user-select: none; /* Safari */
             -webkit-touch-callout: none; /* iOS Safari */
overflow: hidden
}
div, img { position: absolute }
.grid { width: 330px; height: 660px; top: 114px; z-index: -1 }
.boxOuter { width: 66px; height: 66px; z-index: -2 }
.boxFull  { width: 66px; height: 66px }
.boxRight { width: 24px; height: 24px }
.boxLeft  { width: 42px; height: 24px }
.boxUpper { width: 66px; height: 42px }

</style></head><body><script type="text/javascript">

var FX = [
  {name: 'Instante'}, // 0
  {name: 'Morte de Galo'},
  {name: 'Morte de Sapo'},
  {name: 'Morte de Lagarto'},
  {name: 'O Fogo'},

  {name: 'Proteger'},
  {name: 'Coquetel de Camarao'},
  {name: 'O Espelho'},
  {name: 'Mascara'},
  {name: 'Detritos'},

  {name: 'Raio Curto'}, // 10
  {name: 'Impar e Par'},
  {name: 'O Terremoto'},
  {name: 'Sangue'},
  {name: 'Os Espinhos'},

  {name: 'Identificar'},
  {name: 'Alvo Preciso'},
  {name: 'Golias'},
  {name: 'Acabar'},
  {name: 'Explosao'},

  {name: 'Esquecer'}, // 20
  {name: 'Poupanca'},
  {name: 'Senha'},
  {name: 'Adicional'},
  {name: 'Ataque'},

  {name: 'Camarao Novo'},
  {name: 'Caro'},
  {name: 'Esgotar'},
  {name: 'Dormir'},
  {name: 'O Toxico'},

  {name: 'Duplicar'}, // 30
  {name: 'Polimorfo'},
  {name: 'Urdidura do Tempo'},
  {name: 'Teleporte Outro'},
  {name: 'Teleporte'},

  {name: 'Dourado'},
  {name: 'O Pilar'},
  {name: 'Tesouro Escondido'},
  {name: 'Tesouro Perdido'},
  {name: 'Colecao'},

  {name: 'Reflexao'}, // 40
  {name: 'Penetracao'},
  {name: 'Envolver'},
  {name: 'A Energia'},
  {name: 'A Saida'},

  {name: 'Construir'},
  {name: 'Demolicao'},
  {name: 'Raiz Esquerda'},
  {name: 'Curar da Terra'},
  {name: 'Braco Direito Forte'}
];

var ban = [];

for (var i = 0; i < 50; i++) {
  var x = FX[i];
  window[x.name.replace(/ \S/g, function(s){return s.charAt(1).toUpperCase();})] = x;
  x.id = i;
  x.x = i % 5;
  x.y = Math.floor(i / 5);
  x.max = 2;
  ban.push([]);
  for (var j = 0; j < 50; j++) {
    ban[i].push(i === j);
  }
}

Ataque.max = 3;
Identificar.max = 1;
OsEspinhos.max = 1;
ASaida.max = 1;
OTerremoto.max = 1;
Esquecer.max = 1;
Esgotar.max = 1;
MorteDeGalo.max = 1;
UrdiduraDoTempo.max = 1;
Senha.max = 1;
Duplicar.max = 1;

function ex(x, y) {
  var n;
  var i;
  if (Array.isArray(x)) {
    n = x.length;
    for (i = 0; i < n; i++) {
      ex(x[i], y);
    }
    return;
  }
  if (Array.isArray(y)) {
    n = y.length;
    for (i = 0; i < n; i++) {
      ex(x, y[i]);
    }
    return;
  }
  ban[x.id][y.id] = true;
}

function mutex(x, y) {
  var n;
  var i;
  if (!y) {
    n = x.length;
    var m = n - 1;
    for (i = 0; i < m; i++) {
      for (var j = i + 1; j < n; j++) {
        mutex(x[i], x[j]);
      }
    }
    return;
  }
  if (Array.isArray(x)) {
    n = x.length;
    for (i = 0; i < n; i++) {
      mutex(x[i], y);
    }
    return;
  }
  if (Array.isArray(y)) {
    n = y.length;
    for (i = 0; i < n; i++) {
      mutex(x, y[i]);
    }
    return;
  }
  ex(x, y);
  ex(y, x);
}

var WARP = [TeleporteOutro, UrdiduraDoTempo];
var TESOURO = [TesouroPerdido, TesouroEscondido];

mutex(WARP);
mutex(Polimorfo, [WARP, Duplicar]);
mutex(TESOURO);
mutex([AEnergia, Duplicar, TESOURO, OPilar, Dourado]);
mutex(Teleporte, [Explosao, TESOURO, OPilar, CamaraoNovo]);
mutex(Explosao, [OsEspinhos, Caro]);
mutex(CamaraoNovo, CoquetelDeCamarao);
mutex(Golias, [CurarDaTerra, CoquetelDeCamarao]);
mutex([Ataque, Senha], [CoquetelDeCamarao, Mascara, Golias]);
mutex(Ataque, Acabar);
mutex(Mascara, Dormir);
mutex(ImparEPar, RaioCurto);
mutex(Reflexao, [Penetracao, Envolver]);

var MORTE = [MorteDeGalo, MorteDeSapo, MorteDeLagarto];
var AGGRO = [MORTE, CoquetelDeCamarao, ImparEPar, OTerremoto, Sangue, Golias, AlvoPreciso, Acabar, Senha, Ataque];
var DEBUFF = [Esgotar, Dormir, OToxico];
var CONTROL = [Caro, DEBUFF, Duplicar, Polimorfo, WARP];

ex(CONTROL, AGGRO);
ex(Acabar, Senha);
ex(Senha, Ataque);
ex([Senha, Ataque], MORTE);
ex([Senha, Ataque, Mascara], [ImparEPar, Sangue, AlvoPreciso]);
ex([ImparEPar, Sangue, AlvoPreciso], CoquetelDeCamarao);
ex([AGGRO, Caro, Polimorfo, WARP], OEspelho);
ex([Caro, Esgotar, TESOURO], Polimorfo);
ex([Caro, OToxico, Polimorfo], Mascara);
ex(DEBUFF, Caro);
ex([Duplicar, WARP], [Mascara, Caro, DEBUFF]);
ex([OEspelho, WARP, CamaraoNovo, Colecao], Duplicar);
ex([OFogo, OsEspinhos, TESOURO], WARP);
ex(Explosao, TeleporteOutro);
ex(CamaraoNovo, Explosao);
ex(Colecao, Golias);
ex([Polimorfo, WARP, TESOURO, OPilar, Dourado], Colecao);
ex(Demolicao, [OPilar, Construir]);
ex(Identificar, Esquecer);
ex(Instante, Adicional);

var CLEAN = 0;
var MARK = 1;
var RED = 2; // +position = 2~7
var FORG = 8; // +position = 8~13
var EXCL = 14;
var LOW_CHANCE = 15;
var FORG_CHANCE = 16;
var SEL = 17;
var RED_SEL = 18;

var COLOR = ['#fff', '#38c',
  '#f00', '#f00', '#f00', '#f00', '#f00', '#f00',
  '#83c', '#83c', '#83c', '#83c', '#83c', '#83c',
  '#33f', '#bbf', '#caf', '#ff0', '#f80'];

function newState(arrs) {
  var cells = [];
  var slots = [];
  for (var i = 0; i < 5; i++) {
    var a = [];
    var j;
    for (j = 0; j < 50; j++) {
      a.push(arrs ? [CLEAN, CLEAN, CLEAN, CLEAN, CLEAN] : CLEAN);
    }
    cells.push(a);
    a = [];
    for (j = 0; j < 5; j++) {
      a.push([CLEAN, -1]);
    }
    slots.push(a);
  }
  return { cells: cells, slots: slots };
}

var timelines = [[], [], [], [], []];
var sel = null;
var state = newState(false);

function getImg(i) {
  if (i === -1) {
    return null;
  }
  return 'url(cincomancia.png) -' + (FX[i].x * 66) + 'px -' + (FX[i].y * 66) + 'px';
}

function getNum(s) {
  if (s < RED || s > FORG + 5) {
    return -1;
  }
  return (s - RED) % 6;
}

function getNumero(s) {
  var n = getNum(s);
  if (n === -1) {
    return null;
  }
  return 'url(cinconumeros.png) 0 -' + (n * 24) + 'px';
}

var cells = [];
var slots = [];

function colorCell(w, i) {
  var s = state.cells[w][i];
  var col = COLOR[s];
  var num = getNumero(s);
  var cell = cells[w][i];
  if (cell.outer.style.backgroundColor !== col) {
    cell.outer.style.backgroundColor = col;
  }
  if (cell.right.style.background !== num) {
    cell.right.style.background = num;
  }
}

function timePop(w, i) {
  var timeline = timelines[w];
  for (var j = timeline.length - 1; j >= 0; j--) {
    if (timeline[j][0] === i) {
      timeline.splice(j, 1);
      return;
    }
  }
}

function cellClicked(w, i, numero) {
  var s = state.cells[w][i];
  switch (s) {
    case 0:
    case 15:
    case 16:
      timelines[w].push([i, false]);
      state.cells[w][i] = MARK;
      sel = null;
    break;

    case 1:
    case 14:
      timePop(w, i);
      state.cells[w][i] = RED;
      sel = [w, i];
    break;

    case 2:
    case 3:
    case 4:
    case 5:
    case 6:
    case 7:
      if (numero) {
        rightClicked(w, i);
        return;
      }
      timelines[w].push([i, true]);
      state.cells[w][i] += FORG - RED;
      sel = null;
    break;

    case 8:
    case 9:
    case 10:
    case 11:
    case 12:
    case 13:
      if (numero) {
        rightClicked(w, i);
        return;
      } // else fall through
    default:
      timePop(w, i);
      state.cells[w][i] = CLEAN;
      sel = null;
  }
  colorCell(w, i);
  if (state.cells[w][i] !== MARK) {
    recalc();
  }
}

function rightClicked(w, i) {
  sel = (sel !== null && sel[0] === w && sel[1] === i) ? null : [w, i];
  recalc();
}

function slotClicked(w, j) {
  var y = state.slots[w][j];
  if (sel === null) {
    if (y[1] !== -1) {
      sel = [w, y[1]];
      recalc();
    }
    return;
  }
  if (sel[0] !== w) {
    sel = y[1] === -1 ? null : [w, y[1]];
  } else if (y[1] === sel[1]) {
    sel = null;
  } else if (y[0] === RED && state.cells[w][sel[1]] >= RED && state.cells[w][sel[1]] <= RED + 5) {
    state.cells[w][y[1]] = state.cells[w][sel[1]];
    state.cells[w][sel[1]] = RED + 1 + j;
    sel = [w, y[1]];
  } else {
    state.cells[w][sel[1]] = ((state.cells[w][sel[1]] >= RED && state.cells[w][sel[1]] <= RED + 5) ? RED : FORG) + 1 + j;
    sel = null;
  }
  recalc();
}

function recalc() {
  var ns = newState(true);
  var count = [];
  var orig = [];
  var i;
  for (i = 0; i < 50; i++) {
    count.push(0);
  }
  var a;
  var j;
  for (i = 0; i < 5; i++) {
    a = [];
    for (j = 0; j < 5; j++) {
      a.push(-1);
    }
    orig.push(a);
  }
  var t;
  var n;
  var st;
  var pos;
  var y;
  var x;
  var k;
  var l;
  var banBefore;
  var banAfter;
  var w;
  for (w = 0; w < 5; w++) {
    t = timelines[w];
    n = t.length;
    for (j = 0; j < n; j++) {
      y = t[j][0];
      if (t[j][1]) {
        st = state.cells[w][y];
        if (st === FORG) {
          count[y]++;
          for (k = 0; k < 50; k++) {
            if (ban[k][y] && ban[y][k] && k !== y) {
              x = ns.cells[w][k];
              for (l = 0; l < 5; l++) {
                if (x[l] === MARK || x[l] === EXCL) {
                  x[l] = FORG_CHANCE;
                }
              }
            }
          }
        } else {
          pos = st - FORG - 1;
          if (orig[w][pos] === -1) {
            orig[w][pos] = FORG;
            count[y]++;
          }
          ns.slots[w][pos] = [FORG, y];
          for (k = 0; k < 50; k++) {
            banBefore = ban[k][y];
            banAfter = ban[y][k];
            if ((banBefore || banAfter) && k !== y) {
              x = ns.cells[w][k];
              for (l = 0; l < 5; l++) {
                if (l < pos) {
                  if (banBefore) {
                    x[l] = EXCL;
                  }
                } else if (l > pos) {
                  if (banAfter) {
                    x[l] = EXCL;
                  }
                } else {
                  x[l] = FORG_CHANCE;
                }
              }
            }
          }
        }
      } else {
        x = ns.cells[w][y];
        for (k = 0; k < 5; k++) {
          if (x[k] === CLEAN || x[k] === FORG_CHANCE) {
            x[k] = MARK;
          }
        }
      }
    }
  }
  var z;
  var otherReds = [[], [], [], [], []];
  for (i = 0; i < 5; i++) {
    for (j = 0; j < 50; j++) {
      x = state.cells[i][j];
      if (x >= RED && x <= RED + 5) {
        if (x === RED) {
          count[j]++;
          otherReds[i].push(j);
          for (k = 0; k < 50; k++) {
            if (ban[k][j] && ban[j][k] && k !== j) {
              z = ns.cells[i][k];
              for (l = 0; l < 5; l++) {
                z[l] = EXCL;
              }
            }
          }
        } else {
          pos = x - RED - 1;
          if (orig[i][pos] === -1) {
            orig[i][pos] = RED;
            count[j]++;
          }
          ns.slots[i][pos] = [RED, j];
          for (k = 0; k < 50; k++) {
            if (k !== j) {
              z = ns.cells[i][k];
              z[pos] = EXCL;
              banBefore = ban[k][j];
              banAfter = ban[j][k];
              if (banBefore || banAfter) {
                for (l = 0; l < 5; l++) {
                  if (l < pos) {
                    if (banBefore) {
                      z[l] = EXCL;
                    }
                  } else if (l > pos) {
                    if (banAfter) {
                      z[l] = EXCL;
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  }
  var cleans;
  var marks;
  var forgs;
  for (w = 0; w < 5; w++) {
    t = 0;
    for (i = 0; i < 5; i++) {
      if (ns.slots[w][i][0] !== RED) {
        t++;
      }
    }
    for (i = 0; i < 50; i++) {
      st = state.cells[w][i];
      if (st >= RED && st <= FORG + 5) {
        ns.cells[w][i] = st;
      } else if (t === 0) {
        ns.cells[w][i] = EXCL;
      } else {
        cleans = 0;
        marks = 0;
        forgs = 0;
        x = ns.cells[w][i];
        for (j = 0; j < 5; j++) {
          k = x[j];
          if (k === CLEAN) {
            cleans++;
          } else if (k === MARK) {
            marks++;
          } else if (k === FORG_CHANCE) {
            forgs++;
          }
        }
        if (count[i] >= FX[i].max) {
          cleans = 0;
          marks = 0;
        }
        if (cleans === 0) {
          if (forgs > 0) {
            z = FORG_CHANCE;
          } else {
            z = marks >= t ? MARK : EXCL;
          }
        } else {
          cleans += forgs;
          if (cleans + cleans <= t) {
            z = LOW_CHANCE;
          } else {
            z = CLEAN;
          }
        }
        ns.cells[w][i] = z;
      }
    }
  }
  state = ns;
  for (i = 0; i < 5; i++) {
    for (j = 0; j < 50; j++) {
      colorCell(i, j);
    }
    for (j = 0; j < 5; j++) {
      var s = state.slots[i][j];
      st = s[0];
      var col;
      if (sel === null || sel[0] !== i) {
        col = st === CLEAN ? null : COLOR[st];
      } else {
        t = state.cells[i][sel[1]];
        if (j === getNum(t) - 1) {
          col = COLOR[t];
        } else {
          col = COLOR[st === RED ? RED_SEL : SEL];
        }
      }
      var img = getImg((sel !== null && sel[0] === i && state.cells[i][sel[1]] - FORG - 1 === j) ? sel[1] : s[1]);
      var slot = slots[i][j];
      if (slot.outer.style.backgroundColor !== col) {
        slot.outer.style.backgroundColor = col;
      }
      if (slot.img.style.background !== img) {
        slot.img.style.background = img;
      }
    }
  }
}

for (var i = 0; i < 5; i++) {
  var img = document.createElement('img');
  img.src = 'cincomancia.png';
  img.className = 'grid';
  img.style.left = '' + (66 + (i * 396)) + 'px';
  document.body.appendChild(img);
  var a = [];
  var j;
  for (j = 0; j < 50; j++) {
    var cell = {};
    var upper = 116 + (FX[j].y * 66);
    var left = 66 + (i * 396) + (FX[j].x * 66);
    cell.outer = document.createElement('div');
    cell.outer.className = 'boxOuter';
    cell.outer.style.top = '' + upper + 'px';
    cell.outer.style.left = '' + left + 'px';
    cell.outer.style.backgroundColor = COLOR[state.cells[i][j]];
    document.body.appendChild(cell.outer);
    cell.right = document.createElement('img');
    cell.right.src = 'cinconada.png';
    cell.right.className = 'boxRight';
    cell.right.style.top = '' + (upper + 42) + 'px';
    cell.right.style.left = '' + (left + 42) + 'px';
    cell.right.onmousedown = cellClicked.bind(null, i, j, true);
    document.body.appendChild(cell.right);
    cell.left = document.createElement('div');
    cell.left.className = 'boxLeft';
    cell.left.style.top = '' + (upper + 42) + 'px';
    cell.left.style.left = '' + left + 'px';
    cell.left.onmousedown = cellClicked.bind(null, i, j, false);
    document.body.appendChild(cell.left);
    cell.upper = document.createElement('div');
    cell.upper.className = 'boxUpper';
    cell.upper.style.top = '' + upper + 'px';
    cell.upper.style.left = '' + left + 'px';
    cell.upper.onmousedown = cellClicked.bind(null, i, j, false);
    document.body.appendChild(cell.upper);
    a.push(cell);
  }
  cells.push(a);
  a = [];
  for (j = 0; j < 5; j++) {
    var slot = {};
    var left = '' + (66 + (i * 396) + (j * 66)) + 'px';
    slot.outer = document.createElement('div');
    slot.outer.className = 'boxOuter';
    slot.outer.style.top = '24px';
    slot.outer.style.left = left;
    document.body.appendChild(slot.outer);
    slot.img = document.createElement('img');
    slot.img.src = 'cinconada.png';
    slot.img.className = 'boxFull';
    slot.img.style.top = '24px';
    slot.img.style.left = left;
    slot.img.onmousedown = slotClicked.bind(null, i, j);
    document.body.appendChild(slot.img);
    a.push(slot);
  }
  slots.push(a);
}

</script></body></html>

